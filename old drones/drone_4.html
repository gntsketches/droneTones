<!DOCTYPE html>
<html>

<head>
<!--
<script src="https://tonejs.github.io/build/Tone.min.js"></script>
-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.4.10/Tone.min.js"></script>

<style>

	body {
		background: #242;
	}


</style>

</head>

<body>


<button id="start">Start</button>
<button id="stop">Stop</button>
<br><br>


<script>

function remove(array, element) { return array.filter(e => e !== element) }

function getRandomArbitrary(min, max) {
  return Math.random() * (max - min) + min;
}
function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
}
function randomElement(array) {
  return array[Math.floor(Math.random() * array.length)];
}

// var keyToPitch = { " ":" ", "z":"C3", "s":"C#3", "x":"D3", "d":"D#3", "c":"E3", "v":"F3", "g":"F#3", "b":"G3", "h":"G#3", "n":"A3", "j":"A#3", "m":"B3", ",":"C4", "q":"C4", "2":"C#4", "w":"D4", "3":"D#4", "e":"E4", "r":"F4", "5":"F#4", "t":"G4", "6":"G#4", "y":"A4", "7":"A#4", "u":"B4", "i":"C5", "9":"C#5", "o":"D5", "0":"D#5", "p":"E5", "[":"F5", "=":"F#5", "]":"G5", "Backspace":"G#5", "\\":"A5" };


var pitches = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3'];
var pitches2 = ['C2', 'D2', 'E2', 'F2', 'G2', 'A2', 'B2', 'C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3'];


var chroPitches = ['C2', 'C#2', 'D2', 'D#2', 'E2', 'F2', 'F#2', 'G2', 'G#2', 'A2', 'A#2', 'B2', 
									 'C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3',
									 'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4'];


//https://github.com/Tonejs/Tone.js/wiki/Signals
	// so, setTimeouts for a random time to change a value to a random degree
		// values such as: gain 
			// each needs an upper and lower bounds
	// what is the most abstract you can make the value?
	// do you want octave/fifth?
			
function Synth(note){
	this._note = note;
	//this._tremolo = new Tone.Tremolo().start();	
	//this._phaser = new Tone.Phaser();   							
	this._chorus = new Tone.Chorus();										
	this._vibrato = new Tone.Vibrato();									
	this._autoFilter = new Tone.AutoFilter("4n").start();
	this._gain = new Tone.Gain();
	this._synth = new Tone.Synth(4, Tone.Synth).chain(Tone.Master);
	this._noteTimeout - 0;
	this._vibratoDepthTimeout = 0;
	this._vibratoFrequencyTimeout = 0;
	this._volumeTimeout = 0;
}
Synth.prototype.start = function() {
	this._synth.triggerAttack(this._note);
}
Synth.prototype.stop = function() {
	this._synth.triggerRelease();
}
Synth.prototype.setNote = function(note) {
	this._note = note;
}
Synth.prototype.setOscillatorType = function(type) {
	this._synth.oscillator.type = type;
}

Synth.prototype.startTargets = function(effect, minVal, maxVal, minTime, maxTime) {
	var synth = this;
	var time = getRandomArbitrary(minTime, maxTime);
	
	switch(effect){
		//case 'autoFilter':
		//	var val = getRandomArbitrary(minVal, maxVal);
		//	synth._autoFilter.wet.exponentialRampTo(val, time); 
		//	break;
		//case 'chorus':
		//	var val = getRandomArbitrary(minVal, maxVal);
		//	synth._chorus.wet.exponentialRampTo(val, time); 
		//	break;
		case 'note':
			console.log(effect, synth._note);
			var note = minVal || randomElement(maxVal);
			synth.setNote(note)
			synth.start(); 
			synth._noteTimeout = setTimeout(function() { synth.startTargets(effect, minVal, maxVal, minTime, maxTime) }, time*1000+500);
			break;
		case 'vibratoDepth':
			console.log(effect, synth._vibrato.depth.value);
			var val = getRandomArbitrary(minVal, maxVal);
			synth._vibrato.depth.exponentialRampTo(val, time); 
			synth._vibratoDepthTimeout = setTimeout(function() { synth.startTargets(effect, minVal, maxVal, minTime, maxTime) }, time*1000+500);
			break;
		case 'vibratoFrequency':
			console.log(effect, synth._vibrato.frequency.value);
			var val = getRandomArbitrary(minVal, maxVal);
			synth._vibrato.frequency.exponentialRampTo(val, time);
			synth._vibratoFrequencyTimeout = setTimeout(function() { synth.startTargets(effect, minVal, maxVal, minTime, maxTime) }, time*1000+500);
			break;
		case 'volume':
			// could accept input of dB... 
			console.log(effect, synth._synth.volume.value, 'time: ', time);
			var val = getRandomArbitrary(minVal, maxVal);
			synth._synth.volume.exponentialRampTo(val*-40, time)
			synth._volumeTimeout = setTimeout(function() { synth.startTargets(effect, minVal, maxVal, minTime, maxTime) }, time*1000+500);
			break;
	}
	
	
}
Synth.prototype.clearTargets = function() {  
	console.log('vol pre', this._volumeTimeout)
	clearTimeout(this._noteTimeout)
	clearTimeout(this._vibratoDepthTimeout)
	clearTimeout(this._volumeTimeout)
	clearTimeout(this._vibratoFrequencyTimeout)
	console.log('vol post', this._volumeTimeout)
}

	
function Drone(note, numberOfSynths) {   
	this._synths = [];
	this.init = function() {
		if (Array.isArray(numberOfSynths)) { 
			for(var i=0; i<numberOfSynths.length; i++){
				// with random notes instead of note argument 
				this._synths.push(new Synth(randomElement(pitches)));
				this._synths[i].setOscillatorType(numberOfSynths[i]);
				this.appendSynthType(numberOfSynths[i]);
			}
		} else {
		// https://flaviocopes.com/javascript-loops-and-scope/
			for(var i=0; i<numberOfSynths; i++){
				// with random notes instead of note argument
				this._synths.push(new Synth(randomElement(chroPitches)));
				var synthType = this.pickSynthType();
				this._synths[i].setOscillatorType(synthType );
				this.appendSynthType(synthType)
			}
		}
	}
}
Drone.prototype.pickSynthType = function() {
	var synthTypes = [
      'sine','triangle','sawtooth','square', 'amsine','amtriangle','amsawtooth','amsquare',
      'fmsine','fmtriangle','fmsawtooth','fmsquare', 'fatsine','fattriangle','fatsawtooth','fatsquare', 'pwm'
  ];
	var type = synthTypes[Math.floor(Math.random() * synthTypes.length)];
	return type
}
Drone.prototype.appendSynthType = function(type) {
	var elem = document.createElement('div');
	elem.innerHTML = type;
	elem.style.cssText = 'color:#fff;background:#000;font-size:30px;';
	document.body.appendChild(elem);
}
Drone.prototype.start = function() {
	this._synths.forEach(function(synth, index){
		synth.start()
	});
	this._synths.forEach(function(synth, index){
		synth.startTargets('volume', 0, 1, 1, 20)
		synth.startTargets('note', false, pitches2, 1, 20)
		synth.startTargets('vibratoDepth', 0, 1, 1, 20)
		synth.startTargets('vibratoFrequency', 0, 10, 1, 20)
	});
}
Drone.prototype.stop = function() {
	this._synths.forEach(function(synth, index){
		synth.stop()
	});
	this._synths.forEach(function(synth, index){
		synth.clearTargets();
	});
}

	
var drone = new Drone('C2', ['sawtooth', 'sawtooth', 'sawtooth']); //, 'sawtooth', 'sawtooth', 'sawtooth', 'sawtooth'])
drone.init();

document.querySelector('#start').addEventListener('click', () => { 
	drone.start()
})
document.querySelector('#stop').addEventListener('click', () => { 
	drone.stop()
})





// new Synth({ 'oscillator' : { 'type': this.pickSynthType() } } ) );})  // hmmm...


// https://github.com/meleyal/drone.coffee




/*
Ableton question
I frequently copy & paste clips in the arrangement view - focusing a clip with the mouse, then using ctrl-c, then clicking with the mouse to set the vertical cursor bar along the right side of the clip, then using ctrl-shift-v to splice it.
Wondering if there is a keyboard shortcut to do the third step?

*/

</script>



</body>

</html>